---
title: "NZFT_alternatives_a5_colonisation"
author: "T. McMurdo Hamilton"
date: "27/05/2020"
output:
  word_document: default
  html_document: default
---
---
title: "NZFT_alternatives_A5_A8_colonisation"
author: "T. McMurdo Hamilton"
date: "05/05/2020"
output: html_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(popbio)
library(mc2d) # Load betaPERT distribution to describe uncertain parameters
library(sjmisc)
library(tidyr)
library(plyr)
library(reshape2) 
library(dplyr)
library(ggplot2)
library(lme4)
#library(Hmisc)
library(DHARMa)
library(MuMIn)
library(lattice)
library(sjPlot)
library(plotrix)
library(truncnorm)
library(gridExtra)
library(rmarkdown)

#######################################################################################
## Function to translate mean and sd of survival into parameters of a beta distribution
#######################################################################################

beta.params <- function(x_bar, sd.x){
  u <- x_bar*(1-x_bar)/sd.x^2-1
  alpha <- x_bar*u
  beta <- (1-x_bar)*u
  return(list(alpha = alpha, beta = beta))
}

#####################################################################################
## Load expert elicitation data
#####################################################################################

# biol_elicit_raw<-read.csv("C:\\Users\\thmcm\\Documents\\PhD - seabird conservation management\\Fairy Terns and SDM\\NZFT\\DATA\\FAIRY-TERN-R\\df\\Biol_elicit.csv", header=T)

## elicited vals, excluding expert ten for colonisation round:
biol_elicit_raw<-read.csv("C:\\Users\\thmcm\\Documents\\PhD - seabird conservation management\\Fairy Terns and SDM\\NZFT\\DATA\\FAIRY-TERN-R\\df\\Biol_elicit_1to9.csv", header=T)


#biol_elicit_raw<-read.csv("Biol_elicit.csv", header=T)

biol_elicit_raw[,8]<-list(NULL)

## generate mean values for input into models

## filter for round 2

biol<-biol_elicit_raw %>%
  filter(round=="two") %>%
  group_by(parameter) %>%
  summarise(low.mean = mean(low, na.rm=T),best.mean = mean(best, na.rm=T), high.mean = mean(high, na.rm=T),
            low.sd = sd(low, na.rm=T), best.sd = sd(best, na.rm=T), high.sd = sd(high, na.rm=T))

biol<-as.data.frame(biol) # data frame with all the values needed for the alternative strategies' models

## generate mean values for input into models

## filter for round 2

biol<-biol_elicit_raw %>%
  filter(round=="two") %>%
  group_by(parameter) %>%
  summarise(low.mean = mean(low, na.rm=T),best.mean = mean(best, na.rm=T), high.mean = mean(high, na.rm=T),
            low.sd = sd(low, na.rm=T), best.sd = sd(best, na.rm=T), high.sd = sd(high, na.rm=T))

biol<-as.data.frame(biol)

biol$parameter<-trimws(biol$parameter)

#biol # data frame with all the values needed for the alternative strategies' models

# Function that draws the rpert value for each sim from the elicited parameter dataframe 

rperty<-function(param){
  
  df<-biol[biol$parameter == param,]
  rpert_out<-rpert(1,min = df[,2], mode = df[,3], max = df[,4]) # draw the rpert distribution, low, best, high
  df_out<-data.frame(param, rpert_out) # put the result of the rpert into a df
  return(df_out)
  
}


```


# FIELD 2 + CAPTIVE 3 - ALTERNATIVE 5 WITH LEARNING WITHOUT REMOVAL OF INFERTILE MALES #

## Altered to include a probability of birds finding and breeding at new sites ##

Same as alternative 5 but infertile males are kept as foster pairs. Infertility returns to current levels, management frequency goes back to elicited management estimation under field 1 conditions (field 2 was not deemed to be different from field 1). PLUS learning - another change is that success probabilities of captive rearing are reduced by 50% for the first three years, to reflect a learning process.

### MODEL ASSUMPTIONS

##### Birds do not 'unlock' new sites until carrying capacity is reached

##### Adults do not disperse

##### Juveniles are dispersing but its irrelevant to breeding, since they need another year before breeding

##### probability that birds fill each new territory is drawn annually, so number of territories can go up and down 


```{r}
nyears <- 50  # Number of years (projection time frame)
nsim <- 10000 # Number of replicate populations simulated
nharv.occupied <- 6   # Number of years harvesting takes place and released in occupied sites (no year 0)
nharv.new <- 11 # number of years overall that harvesting takes place
nlearn <- 3 # number of years that ex situ teams are 'learning' techniques

# scenario with extended captive rearing and high K
# 
#nharv.occupied <- 11   # Number of years harvesting takes place and released in occupied sites
#nharv.new <- 21 # number of years overall that harvesting takes place


# Define empty arrays, vectors and initial stage-specific population sizes
# There will now be 5 life stages: captive managed juveniles and immatures, wild juvs and imms plus one adult stage

Ni <- c(0, 0, 3, 0, 14) # starting population vector
N <- array(0, dim = c(5, nyears + 1, nsim)) # edited for five life stages (two semi-captive stages)
N[,1,] <- Ni 

alive <- matrix(0, nrow = nyears, ncol = nsim) 
r <- matrix(0, nrow = nyears, ncol = nsim)
mean.r.a5 <- lambda.a5 <- persist.a5 <- numeric()   # empty vectors for r, lambda, p(persistence > 2)
sj.val.a5 <- si.val.a5 <- sa.val.a5 <- Fa.val.a5 <- Fac.val.a5 <- array(NA,dim=c(nyears,nsim)) # empty vectors for sensitivity
learn <- numeric()


```

Define constants or non-elicited, fixed values

## Carrying capacity is set at two levels ##

1. Car.lwr - Field 2 number of territories -  if the sites aren't found or populated, should provide the same outcome as Field 2

2. Car - which is set to the lower value out of:
number of birds "floating" / in excess of the lower carrying capacity (i.e. in theory, birds that have nowhere within the current range to breed) multiplied by the probability they find and breed at a new site;
or 24 i.e. number of territories set for Field 2 + new sites

```{r}

# Define constants or non-elicited, fixed values

X <- 0.47                  #'cost' of management-reduction in prob of fledging from egg, calc from GLMM outputs
infer <-0.679              # mean proportion of fertile eggs 
infer.e <- 0.156           # uncertainty expressed as SD of the mean
c <- 1.73                  # mean clutch size 
c.e <- 0.45                # uncertainty expressed as standard deviation of the mean
harvest1 <- 0.5            # first clutch harvest rule, set to 50% of breeding females
harvest2 <- 0.2            # second clutch harvest rule, 20% of breeding females ()
relay <- 0.52              # the proportion of females that lay again after failing at egg or chick stage in their first clutch

# Define temporal variation 

Sjuv.t <- 0.001           # temporal variability of juvenile survival (would be expressed as SD on logit scale)
Simm.t <- 0.001           # temporal variability of immature survival (would be expressed as SD on logit scale)
Sad.t <- 0.001            # temporal variability of immature survival (would be expressed as SD on logit scale)
h.t <- 0.2046             # temporal variability of hatch prob (from model m2) expressed as untransformed SD
fl.t <- 0.2389            # temporal variability of fledge prob (from model f3) expressed as untransformed SD
 

# Define carrying capacity, if using a fixed value

Car.lwr<- 18                  # most likely value for Field 2
Car.upr<- 24                  # most likely, elicited expert value for Field 2 + Captive 3
Car.I.upr <-2                 # elicited spaces in Ruakaka
Car.O.upr <-4                 # elicited spaces in GBI

# double capacity - assume that there is double the amount of room predicted

# Car.lwr<- 36                  # most likely value for Field 2
# Car.upr<- 48                  # most likely, elicited expert value for Field 2 + Captive 3
# Car.I.upr <-4                 # elicited spaces in Ruakaka
# Car.O.upr <-8                 # elicited spaces in GBI

# high capacity - assume that we are wrong about FT ability to breed in colony

# Car.lwr<- 50                  # mock value for Field 2
# Car.upr<- 50                  # mock value for Field 2 + Captive 3
# Car.I.upr <-20                # mock spaces in Ruakaka
# Car.O.upr <-20                # mock spaces in GBI


Car<- matrix(NA,nrow=nyears+1,ncol=nsim) # Track carrying capacity across time and sim
Car[1,] <- Car.lwr # Carrying capacity in the first year is always the lowest value

Car.I <-matrix(NA,nrow=nyears+1,ncol=nsim)
Car.I[1,] <-Car.I.upr # Carrying capacity in the first year is at the upper bound as the site has just been created

Car.O <-matrix(NA,nrow=nyears+1,ncol=nsim)
Car.O[1,] <-Car.O.upr  # Carrying capacity in the first year is at the upper bound as the site has just been created

```

Run simulation


```{r}

for (s in 1:nsim){                                          # Loop over replicate populations
  if(s %% 100 == 0) {cat(paste("*** Simrep", s, "***\n")) } # Counter
  
  p_out<-lapply(biol$parameter,rperty)
  p_out<- do.call(rbind, p_out)
  
  # Generate mean demographic values from elicited data
  
  # elicited survival parameters
  
  # wild - assume all are under F2 instead of some F1, some F2 (to simplify)
  
  sj.sim <- as.numeric(filter(p_out, param == "sjuv.f2") %>% select(rpert_out)) 
  si.sim <- as.numeric(filter(p_out, param == "simm.f2") %>% select(rpert_out))
  sa.sim <- as.numeric(filter(p_out, param == "sad.f2") %>% select(rpert_out))
  
  # captive, occupied site release
  
  sjc.sim <- as.numeric(filter(p_out, param == "sjuv.cap") %>% select(rpert_out)) # captive juv surv (annual)
  sjr.sim <- as.numeric(filter(p_out, param == "sjuv.rel.oc") %>% select(rpert_out)) # rel juv surv (annual)
  sir.sim <- as.numeric(filter(p_out, param == "simm.rel.oc") %>% select(rpert_out)) # rel imm surv (annual)
 
   # captive, new site release
  
  sjn.sim <- as.numeric(filter(p_out, param == "sjuv.rel.n") %>% select(rpert_out)) 
  sin.sim <- as.numeric(filter(p_out, param == "simm.rel.n") %>% select(rpert_out)) 
  
  
  # elicited breeding parameters

  
  h.sim <- as.numeric(filter(p_out, param == "h.f2") %>% select(rpert_out))    # wild params
  fl.sim <- as.numeric(filter(p_out, param == "fl.f2") %>% select(rpert_out))  # wild params
  
  hc.sim <- as.numeric(filter(p_out, param == "h.cap") %>% select(rpert_out))    # captive params
  flc.sim <- as.numeric(filter(p_out, param == "fl.cap") %>% select(rpert_out))  # captive params
  
  K.sim <- as.numeric(filter(p_out, param == "K.f2") %>% select(rpert_out)) # using field 2 elicited vals
  M.sim <- as.numeric(filter(p_out, param == "M.f1") %>% select(rpert_out)) # same as field 1, proportion nests managed
  c.sim <- as.numeric(filter(p_out, param == "c.f2") %>% select(rpert_out)) # using field 2 elicited vals
  
  
  # Generate annual demographic rates (subject to temporal variability)
  # Bound between 0 and 1, hence the transformation through the logit link
  
  sj <- plogis(rnorm(nyears, qlogis(sj.sim), Sjuv.t))
  sjc <- plogis(rnorm(nyears, qlogis(sjc.sim), Sjuv.t))
  sjr <- plogis(rnorm(nyears, qlogis(sjr.sim), Sjuv.t))
  si <- plogis(rnorm(nyears, qlogis(si.sim), Simm.t))
  sir <- plogis(rnorm(nyears, qlogis(sir.sim), Simm.t))
  sjn <- plogis(rnorm(nyears, qlogis(sjn.sim), Sjuv.t))
  sin <-  plogis(rnorm(nyears, qlogis(sin.sim), Simm.t))
  sa <- plogis(rnorm(nyears, qlogis(sa.sim), Sad.t))
  ha <- plogis(rnorm(nyears, h.sim, h.t))
  fla <- plogis(rnorm(nyears, fl.sim, fl.t))
  hac <- plogis(rnorm(nyears, hc.sim, h.t))
  flac <- plogis(rnorm(nyears, flc.sim, fl.t))
  
  
  Ka <- rnorm(nyears, K.sim, 0) # no temporal var in K
  Ma <- rnorm(nyears, M.sim, 0) # no temporal var in M
  ca <- rnorm(nyears, c.sim, 0) # no temporal var in clutch size
  

#### elicited probabilities of colonisation  ##################################################################
  
  # wild and captive recruits released in range will unlock territories in range (e.g. Ruakaka) 2a
prob.unlock.I.recruits<- as.numeric(filter(p_out, param == "p.unlock.I.rs") %>% select(rpert_out)) 
  
  # adult dispersers without a territory will unlock territories in range (e.g. Ruakaka)
prob.unlock.I.floaters<- as.numeric(filter(p_out, param == "p.unlock.I.fs") %>% select(rpert_out)) 

  # wild and captive recruits released in range will unlock territories outside range (e.g. GBI)
prob.unlock.O.recruits<- as.numeric(filter(p_out, param == "p.unlock.O.rs") %>% select(rpert_out)) 

  # adult dispersers without a territory will unlock territories outside range (e.g. GBI)
prob.unlock.O.floaters<- as.numeric(filter(p_out, param == "p.unlock.O.fs") %>% select(rpert_out)) 

  # captive recruits released outside range will unlock territories outside range (e.g. GBI)
prob.unlock.O.recruits.n<- as.numeric(filter(p_out, param == "p.unlock.O.crsn") %>% select(rpert_out)) 


#####################################################################################################################

  # Project population (include demographic stochasticity)
  
  for (t in 1:nyears){ # Loop over years
    
  # Step 1: survival and fecundity for this year
    
    # Harvest rates
    harvest1 <- ifelse(t <= nharv.new,0.5,0) # after 11 years, both harvest rates go to zero
    harvest2 <- ifelse(t <= nharv.new,0.2,0)
    learn <- ifelse(t<=nlearn, 0.5,1) # reduce the probabilities by 50% for the first 3 years
    
    # Juvenile survival
    sjc6 <- (sjc[t]^(1/12))^6 # 6 months survival in captivity
    sjr6 <- (sjr[t]^(1/12))^6 # 6 months survival in the wild at OCC sites after captivity
    sjn6 <- (sjn[t]^(1/12))^6 # 6 months survival in the wild at NEW sites after captivity
    
    # fecundity equation, with harvested nests replaced (relaying)
    # nests left after first harvest, plus re-lays at the replacement rate minus the re-lays that are taken on second harvest (in multiplication clause)
    Fa <- (Ka[t]*ca[t]*infer*((1-harvest1)+(harvest1*relay)*(1-harvest2))*((Ma[t]*X)+(1-Ma[t]))*(ha[t]*fla[t]))/2
    
    # captive productivity - occupied and new site releases the same
    Fac <- learn*(Ka[t]*ca[t]*infer*(harvest1+(harvest1*relay*harvest2))*hac[t]*flac[t])/2
    
    # after harvesting is finished, captive fecundity goes to zero
    
    ####
    
  # Step 2: dispersal  - HOW MANY BIRDS?

### are there adult birds that don't hold a territory (floaters)? how many? 

# if the population is greater than carrying capacity, then the number of floating birds is the difference of the two, 
# otherwise it is zero

   wild.dispersers<-ifelse(N[5,t,s]>Car[t,s], N[5,t,s] - Car[t,s], 0)
    
    # if we assume that any wild adult bird can colonise any territory, then:
    
  # wild.dispersers<-N[5,t,s]

### how many recruits are there? - depends on year
   
# t =< n.harv.occupied, captive in range releases
# n.harv.occupied < t < n.harv.new, captive outside range releases
# t > n.harv.new, captive rearing is finished

  # How many released juveniles from last year (i.e. released two years ago) have survived to the adult stage? (from the matrix)
  # this includes released from occ sites and new sites   
  captive.recruits <- rbinom(1,N[4,t,s],ifelse((t-1)<nharv.occupied,sir[t],sin[t])) 

## Q. why t-1? to account for the delay; they are released a year ago, so if they are released at year 6, then in year 7 ## they are still experiencing surv rates for immatures released in range (year 7 is in the GBI releases timeframe, surv ## imm out of range)

# How many wild-born immatures from last year have survived to the adult stage?

  wild.recruits <- rbinom(1,N[3,t,s],si[t]) 


  # Step 3: determine carrying capacity for this year
    if ((t-1)<= nharv.new){       # if any captive rearing happening
  
        if ((t-1)<= nharv.occupied){  # and releases are in range (depends on whether assume sites are avail immediately                                       
          # or after 5 yrs)
  
    # firstly, are there new unlocks at the new site inside the range
    
    # all recruits unlock first, then adult dispersers without territory (floaters) of whatever is left
    wcr.unlock.I <-min(rbinom(1, (captive.recruits + wild.recruits), prob.unlock.I.recruits), Car.I[t,s])  
    wd.unlock.I <-min(rbinom(1, wild.dispersers, prob.unlock.I.floaters), Car.I[t,s] - wcr.unlock.I) 
    
    # are there new unlocks outside of the range, presuming INside sites unlock first, by recruits then dispersers 
    wcr.unlock.O <-min(rbinom(1, ((captive.recruits + wild.recruits) - wcr.unlock.I), 
                              prob.unlock.O.recruits), Car.O[t,s])
    wd.unlock.O <-min(rbinom(1, (wild.dispersers - wd.unlock.I), prob.unlock.O.floaters), Car.O[t,s]-wcr.unlock.O)
    
    new.unlock.I <- wd.unlock.I + wcr.unlock.I # total unlocks inside range
    new.unlock.O <- wd.unlock.O + wcr.unlock.O # total unlocks outside range
     
    # Car.I and Car.O have only slots that are left from th year previous (cap total carrying capacity here)
    Car.I[t+1,s] <- min(Car.I[t,s] - new.unlock.I, Car.I.upr)
    Car.O[t+1,s] <- min(Car.O[t,s] - new.unlock.O, Car.O.upr)
  
    # Car is last year's carrying capacity plus new unlocks (capped above)
    Car[t+1,s] <- Car[t, s] + new.unlock.I + new.unlock.O
                  
  
  }else{ # releases are outside of range
    
    # captive recruits that were released outside range unlock outside of range territories first (no more than upr)
    cr.unlock.O <- min(rbinom(1, captive.recruits, prob.unlock.O.recruits.n), Car.O[t,s])
    
    # then wild recruits, plus any captive recruits that came back to main group, unlock new territories INside range
    # then wild dispersers recruit INside range
    
    wr.unlock.I <- min(rbinom(1, wild.recruits, prob.unlock.I.recruits), Car.I[t,s])
    cr.unlock.I <- min(rbinom(1, captive.recruits - cr.unlock.O, prob.unlock.I.recruits), Car.I[t,s]-wr.unlock.I)
    wd.unlock.I <- min(rbinom(1, wild.dispersers, prob.unlock.I.floaters), 
                           Car.I[t,s] - cr.unlock.I - wr.unlock.I) 
    
    # finally wild recruits and wild dispersers can unlock territories OUT of range, in that order
    
    wr.unlock.O <-min(rbinom(1, wild.recruits - wr.unlock.I, prob.unlock.O.recruits), Car.O[t,s] - cr.unlock.O) 
    wd.unlock.O <-min(rbinom(1, wild.dispersers - wd.unlock.I, prob.unlock.O.floaters), 
                           Car.O[t,s] - cr.unlock.O - wr.unlock.O)

    new.unlock.I <- cr.unlock.I + wr.unlock.I + wd.unlock.I # total unlocks inside range
    new.unlock.O <- cr.unlock.O + wr.unlock.O + wd.unlock.O # total unlocks outside range
    
                  
    # Car.I and Car.O have only slots that are left from the year previous (cap total carrying capacity here)
    Car.I[t+1,s] <- min(Car.I[t,s] - new.unlock.I, Car.I.upr)
    Car.O[t+1,s] <- min(Car.O[t,s] - new.unlock.O, Car.O.upr)
    
    # Car is last year's carrying capacity plus new unlocks (capped above)
    Car[t+1,s] <- Car[t, s] + new.unlock.I + new.unlock.O
}
 
}else{ # if captive rearing is finished, only wild recruits and wild dispersers in the population
  
  # wild recruits unlock first, INside range, then wild dispersers without territory, INside
  wr.unlock.I <- min(rbinom(1, wild.recruits, prob.unlock.I.recruits), Car.I[t,s])
  wd.unlock.I <- min(rbinom(1, wild.dispersers, prob.unlock.I.floaters), 
                         Car.I[t,s] - wr.unlock.I)
  
  # then wild recruits unlock OUTside range, then wild dispersers without territory, OUTside
  wr.unlock.O <-min(rbinom(1, wild.recruits - wr.unlock.I, prob.unlock.O.recruits), Car.O[t,s]) 
  wd.unlock.O <-min(rbinom(1, wild.dispersers - wd.unlock.I, prob.unlock.O.floaters), 
                         Car.O[t,s] - wr.unlock.O)

  new.unlock.I <- wr.unlock.I + wd.unlock.I # total unlocks inside range
  new.unlock.O <- wr.unlock.O + wd.unlock.O # total unlocks outside range
  
  # Car[t+1,s] <- min(Car[t, s] + new.unlock.I + new.unlock.O, Car.upr)
  
  # Car.I and Car.O have only slots that are left from the year previous (cap total carrying capacity here)
  Car.I[t+1,s] <- min(Car.I[t,s] - new.unlock.I, Car.I.upr)
  Car.O[t+1,s] <- min(Car.O[t,s] - new.unlock.O, Car.O.upr)
  
  # Car is last year's carrying capacity plus new unlocks (capped above)
  Car[t+1,s] <- Car[t, s] + new.unlock.I + new.unlock.O
  
}

  # Step 4: matrix for next year
    N[1,t+1,s] <- rpois(1, min(Car[t,s], N[5,t,s]) * sa[t] * Fa)  # Wild fledglings
    N[2,t+1,s] <- rpois(1, min(Car[t,s], N[5,t,s]) * sa[t] * Fac)
    N[3,t+1,s] <- rbinom(1, N[1,t,s], sj[t])  # Wild juveniles
    N[4,t+1,s] <- rbinom(1, N[2,t,s], sjc6 * ifelse(t<nharv.occupied, sjr6,sjn6)) # Captive-born juveniles
    N[5,t+1,s] <- rbinom(1,(N[5,t,s]), sa[t]) + wild.recruits + captive.recruits  # All adults
   
    # if (sum(N[,t+1,s]) == 0)break
    # else {
      r[t,s] <- ifelse(sum(N[,t+1,s]) == 0, 0, log(sum(N[,t+1,s])) - log(sum(N[,t,s]))) # calculate r for each time step in each sim
      alive[t,s] <- t
    # } # else
    
    
    persist.a5[t]<- sum(N[5,t,]>2)  / s # persistence probability at each timestep

    # Store values
    sj.val.a5[t,s] = sj.sim
    si.val.a5[t,s] = si.sim
    sa.val.a5[t,s] = sa.sim
    Fa.val.a5[t,s] = Fa
    Fac.val.a5[t,s] = Fac    
    
  } # t
  
  Fa.val.a5[,1]
  
  mean.r.a5[s] <- mean(r[min(alive[,s], na.rm = TRUE):max(alive[,s], na.rm = TRUE),s])
  lambda.a5[s] <- exp(mean.r.a5[s])
  
} # s

```

### Extinction Probabilities


```{r}

# mean carrying capacity 

mean(Car[nyears,], na.rm=T)

# Extinction probability (after nyears)

sum(N[5,nyears,]==0) / nsim

# calculation of quasi-extinction 

sum(apply(N[5,,1:nsim],2,min)<3)/nsim # adults only

pexta5u<-sum(apply(N[5,,1:nsim],2,min)<3)/nsim

# work out how to remove top two lines of matrix?
#sum(apply(colSums(N[-1,,1:nsim]),2,min)<3)/nsim # immatures and adults only

#Probability that population is equal to or smaller than the initial adult population size in year 1, 
#and probability that population is surviving, but equal to or less than the 2017 size.

sum(N[5,nyears,]<=N[5,1,1]) / nsim

# store persistence

write.csv(persist.a5, "persist_A5_learn_keepinf_colonise_07_12.csv")

```

### Lambda, population year 50 summary

```{r}
# mean growth rates, mean and median

mean(lambda.a5)
sd(lambda.a5)

# store lambda
write.csv(lambda.a5,"lambda_A5_learn_keepinf_colonise_07_12.csv")

summary(N[5,51,])
alt5colonise.summary<-summary(N[5,51,])

```

### Plots Alternative 5 with infertile males kept plus learning plus colonise 

```{r}

#write.csv(N[5,,1:nsim], "Pop_simulation_adults_A5-learn-infer-colonise.csv")

# prep data for plots

N.mean <- apply(N,c(1,2),mean)
N.sd <- apply(N, c(1,2), sd)
N.lci <- apply(N,c(1,2),quantile, probs=c(.025))
N.uci <- apply(N,c(1,2),quantile, probs=c(.975))
N.upr <- N.mean + 1.96*N.sd                       # upper 95% confidence level (1.96 * SD)
N.lwr <- N.mean - 1.96*N.sd                       # lower 95% confidence level
N.25 <- apply(N,c(1,2),quantile, probs=c(.25))    # lower quartile
N.50 <- apply(N,c(1,2),quantile, probs=c(.5))     # median quartile
N.75 <- apply(N,c(1,2),quantile, probs=c(.75))    # upper quartile


plot_results_a5update = data.frame(alt = "fiveupdate", years = 1:51, N.mean=N.mean[5,], N.uci = N.uci[5,], N.lci=N.lci[5,], N.upr = N.upr[5,], N.lwr = N.lwr[5,], N.25 = N.25[5,],N.50 = N.50[5,], N.75 = N.75[5,])

# store projections

#write.csv(plot_results_a5update, "proj_A5_learn_keepinf_colonise_07_12.csv")

N50_a5<-N[5,50,1:nsim] # store the adult population sizes at the end of simulation

N25_a5<-N[5,25,1:nsim] # store the adult population sizes halfway through simulation

# store final population sizes

#write.csv(N50_a5, "Finalpopsize_A5_learn_keepinf_colonise_07_12.csv")

# N50_a5<-read.csv("C:\\Users\\thmcm\\Documents\\PhD - seabird conservation management\\Fairy Terns and SDM\\Decision Making\\TARA ITI WORKSHOP\\Phase 4\\Population modelling results\\Final pop sizes 5000 sims elicited K\\Final_pop_sizes_t=50_alt5_learn_inf_colonise.csv", header=T)
# N50_a5[,3]<-"A5 - F2 + Cap3 + learn + inf + colonise"


```


# PLOTS

```{r}

# plot population projection with mean adult population size and uncertainty over 50 years
gg5<-ggplot(plot_results_a5update, aes(x=years, y=N.mean)) + 
  geom_ribbon(aes(x = years, ymax=N.upr, ymin=N.lwr),fill = "lightgrey", alpha=0.35) +   
  geom_ribbon(aes(x = years, ymax=N.75, ymin=N.25), fill = "dimgrey", alpha=0.35) + 
  geom_line(aes(x = years, y=N.50), color="white", size = 2, alpha=0.6) + geom_line(color="black", size=1, alpha=0.6) + 
  theme_classic(base_size = 16)+  coord_cartesian(ylim=c(0,100))  + 
  labs(title = "Predicted mean tara iti population size", x = "Year", y = "Population size (adult females)")

# gg5

gg.a5<-ggplot(plot_results_a5update, aes(x=years, y=N.mean)) + 
  geom_ribbon(aes(x = years, ymax=N.upr, ymin=N.lwr),fill = "dimgrey", alpha=0.35) + 
  geom_line(color="mediumblue", size=1.5, alpha=0.6) +
  scale_x_continuous(expand=c(0,0)) +
  scale_y_continuous(expand=c(0,0)) +
  theme_classic(base_size = 16)+  
  coord_cartesian(ylim=c(0,100))  + 
  labs(title = "Alternative 5 + learning + keep infertile males", x = "Year", y = "Population size (adult females)")

gg<-ggplot(plot_results_a5update, aes(x=years, y=N.mean)) + 
  geom_ribbon(aes(x = years, ymax=N.upr, ymin=N.lwr),fill = "dimgrey", alpha=0.35) + 
  geom_line(color="mediumblue", size=1.5, alpha=0.6) + 
  scale_x_continuous(expand=c(0,0)) +
  scale_y_continuous(expand=c(0,0)) +
  theme_classic(base_size = 16)+
  coord_cartesian(ylim=c(0,150))  +
  labs(title = "Predicted mean tara iti population size", x = "Year", y = "Population size (adult females)")

gg5
gg.a5
gg

plot_results_a5update

x<-1:nyears
plot(x, persist.a5, type = "l", cex = 1.5, lwd = 2, ylim = c(0.75,1), xlab = "Years", ylab = "p (persistence)")


plot(density(lambda.a5))
#plot(density(lambda.a5), lwd = 2, col = "green", xlim = c(0.8,1.1)) + lines(density(lambda.SQf1), lwd = 2)

```

#######################################################################################################

# MODEL FIELD 2 NEW SITES

# Code for Alternative "Field 2 + new sites" WITH probability that birds find and breed at new sites

This simulation has field two management plus new sites as defined in alternative 5 (two sites, comprising the size of Ruakaka and GBI)

## Carrying capacity is set at two levels - as above

## Model assumptions - as above

Simulation:

```{r}

# Define the number of years with predictions and the Monte Carlo setting

nyears <- 50 # Number of years (projection time frame)
nsim <- 10000 # Number of replicate populations simulated


# Define empty arrays, vectors and initial stage-specific population sizes

Ni <- c(0, 3, 14) # starting population vector
N <- array(0, dim = c(3, nyears + 1, nsim)) # edited for three life stages
N[,1,] <- Ni 

alive <- matrix(0, nrow = nyears, ncol = nsim) 
r <- matrix(0, nrow = nyears, ncol = nsim)
mean.r.a8 <- numeric()
sj.val.a8 <- si.val.a8 <- sa.val.a8 <- Fa.val.a8 <- persist.a8<- lambda.a8<- numeric() 

Car.upr <- Car.lwr <- Car.I.upr <- Car.O.upr <- numeric()
Car<- matrix(NA,nrow=nyears+1,ncol=nsim) # Track carrying capacity across time and sim
Car.I <-matrix(NA,nrow=nyears+1,ncol=nsim)
Car.O <-matrix(NA,nrow=nyears+1,ncol=nsim)

## s is parametric uncertainty

# Define constants or non-elicited, fixed values

X <- 0.47                        #'cost' of management-reduction in prob of fledging from egg, calc from GLMM outputs
infer <-0.679                    # mean proportion of fertile eggs 
infer.e <- 0.156                 # uncertainty expressed as SD of the mean

# Define temporal variation 

Sjuv.t <- 0.01                 # temporal variability of juvenile survival (would be expressed as SD on logit scale)
Simm.t <- 0.01                 # temporal variability of immature survival (would be expressed as SD on logit scale)
Sad.t <- 0.01                  # temporal variability of immature survival (would be expressed as SD on logit scale)
h.t <- 0.2046                  # temporal variability of hatch prob (from model m2) expressed as untransformed SD
fl.t <- 0.2389                 # temporal variability of fledge prob (from model f3) expressed as untransformed SD


```

How many birds are there?

```{r}

# Project population

for (s in 1:nsim){                                          # Loop over replicate populations
  if(s %% 100 == 0) {cat(paste("*** Simrep", s, "***\n")) } # Counter
  
  p_out<-lapply(biol$parameter,rperty)
  p_out<- do.call(rbind, p_out)
  
  # Generate mean demographic values from elicited data
  
  # elicited survival parameters
  
  sj.sim <- as.numeric(filter(p_out, param == "sjuv.f2") %>% select(rpert_out)) # dplyr
  si.sim <- as.numeric(filter(p_out, param == "simm.f2") %>% select(rpert_out))
  sa.sim <- as.numeric(filter(p_out, param == "sad.f2") %>% select(rpert_out))
  
  # elicited breeding parameters
  
  h.sim <- as.numeric(filter(p_out, param == "h.f2") %>% select(rpert_out))
  fl.sim <- as.numeric(filter(p_out, param == "fl.f2") %>% select(rpert_out))
  M.sim <- as.numeric(filter(p_out, param == "M.f1") %>% select(rpert_out)) # same as Field 1
  K.sim <- as.numeric(filter(p_out, param == "K.f2") %>% select(rpert_out))
  c.sim <- as.numeric(filter(p_out, param == "c.f2") %>% select(rpert_out))
  
  Car.lwr <- round(as.numeric(filter(p_out, param=="Car.f2") %>% select(rpert_out)))
  Car.I.upr <- round(as.numeric(filter(p_out, param=="Car.I") %>% select(rpert_out)))
  Car.O.upr <- round(as.numeric(filter(p_out, param=="Car.O") %>% select(rpert_out)))
  Car.upr <- Car.lwr + Car.I.upr + Car.O.upr

  Car[1,] <- Car.lwr # Carrying capacity in the first year is always the lowest value
  Car.I[1,] <-Car.I.upr # Carrying capacity in the first year is at the upper bound as the site has just been created
  Car.O[1,] <-Car.O.upr  # Carrying capacity in the first year is at the upper bound as the site has just been created
  
  
  # Generate annual demographic rates (subject to temporal variability)
  
  sj <- plogis(rnorm(nyears, qlogis(sj.sim), Sjuv.t))
  si <- plogis(rnorm(nyears, qlogis(si.sim), Simm.t))
  sa <- plogis(rnorm(nyears, qlogis(sa.sim), Sad.t))
  ha <- plogis(rnorm(nyears, h.sim, h.t))
  fla <- plogis(rnorm(nyears, fl.sim, fl.t))
  Ma <- rnorm(nyears, M.sim, 0) # no temporal var in M
  Ka <- rnorm(nyears, K.sim, 0) # no temporal var in prop of fem breeding
  ca <- rnorm(nyears, c.sim, 0) # no temporal var in clutch size
  
  #### elicited probabilities of colonisation ################################

prob.unlock.I.recruits<- as.numeric(filter(p_out, param == "p.unlock.I.rs") %>% select(rpert_out)) # recruits will unlock territories in range (e.g. Ruakaka) question 2a
prob.unlock.I.floaters<- as.numeric(filter(p_out, param == "p.unlock.I.fs") %>% select(rpert_out)) # adult dispersers without a territory will unlock territories in range (e.g. Ruakaka)
prob.unlock.O.recruits<- as.numeric(filter(p_out, param == "p.unlock.O.rs") %>% select(rpert_out)) # recruits will unlock territories outside range (e.g. GBI)
prob.unlock.O.floaters<- as.numeric(filter(p_out, param == "p.unlock.O.fs") %>% select(rpert_out)) # adult dispersers without a territory will unlock territories outside range (e.g. GBI)

  
 ### Project population (include demographic stochasticity)
  
  for (t in 1:nyears){ # Loop over years
      # Step 1: fecundity
    
     Fa <- (Ka[t]*ca[t]*infer*((Ma[t]*X)+(1-Ma[t]))*(ha[t]*fla[t]))/2  # fecundity equation 
     
      # Step 2: dispersal 

### are there adult birds that don't hold a territory (floaters)? how many? 

  wild.dispersers<-ifelse(N[3,t,s]>Car[t,s], N[3,t,s] - Car[t,s], 0)
  
  # Or, if adults can disperse to new territories regardless of whether the breeding site is at carrying capacity:
	
  # wild.dispersers<-N[3,t,s]


# How many wild-born immatures from last year have survived to the adult stage?

  wild.recruits <- rbinom(1,N[2,t,s],si[t]) 

     # Step 3: determine carrying capacity for this year
  #  only wild recruits and wild dispersers in the population
  
  # wild recruits unlock first, INside range, then wild dispersers without territory, INside
  wr.unlock.I <- min(rbinom(1, wild.recruits, prob.unlock.I.recruits), Car.I[t,s])
  wd.unlock.I <-min(rbinom(1, wild.dispersers, prob.unlock.I.floaters), 
                    Car.I[t,s] - wr.unlock.I)
  
  # then wild recruits unlock OUTside range, then wild dispersers without territory, OUTside
  wr.unlock.O <-min(rbinom(1, wild.recruits - wr.unlock.I, prob.unlock.O.recruits), Car.O[t,s]) 
  wd.unlock.O <-min(rbinom(1, wild.dispersers - wd.unlock.I, prob.unlock.O.floaters), 
                    Car.O[t,s] - wr.unlock.O)
  
  new.unlock.I <- wr.unlock.I + wd.unlock.I # total unlocks inside range
  new.unlock.O <- wr.unlock.O + wd.unlock.O # total unlocks outside range
  
  # Car.I and Car.O have only slots that are left from the year previous (cap total carrying capacity here)
  Car.I[t+1,s] <- min(Car.I[t,s] - new.unlock.I, Car.I.upr)
  Car.O[t+1,s] <- min(Car.O[t,s] - new.unlock.O, Car.O.upr)
  
  # Car is last year's carrying capacity plus new unlocks (capped above)
  Car[t+1,s] <- Car[t,s] + new.unlock.I + new.unlock.O
  
  # Step 4: matrix for next year
  
    N[1,t+1,s] <- rpois(1, (min(Car[t,s], N[3,t,s]) * sa[t] * Fa))
    N[2,t+1,s] <- rbinom(1, (N[1,t,s]), sj[t])
    N[3,t+1,s] <- wild.recruits + rbinom(1, (N[3,t,s]), sa[t])
    
    r[t,s] <- ifelse(sum(N[,t+1,s]) == 0, 0, log(sum(N[,t+1,s])) - log(sum(N[,t,s]))) # calculate r for each time step in each sim
      alive[t,s] <- t
    
    persist.a8[t]<- sum(N[3,t,]>2)  / s # persistence probability at each timestep
    
  } # t
  
  sj.val.a8[s] = sj.sim
  si.val.a8[s] = si.sim
  sa.val.a8[s] = sa.sim
  Fa.val.a8[s] = Fa
  mean.r.a8[s] <- mean(r[min(alive[,s], na.rm = TRUE):max(alive[,s], na.rm = TRUE),s])
  lambda.a8[s] <- exp(mean.r.a8[s])
  
} # s

```


```{r}
# Intrinsic growth rates and population extinction probability
mean(Car[nyears,], na.rm=T)

#Calculate the probability of extinction after 50 years. Important to define what we class as 'extinction' here. The population has historically gone down to 3 known pairs. Makes sense to look at the rate of populations going to zero adults females and the rate of populations going down to 2 adult females.

#Mean intrinsic growth rate (and standard deviation)

mean(mean.r.a8) 
sd(mean.r.a8)

#Mean intrinsic growth rate of surviving populations

not.extinct <- which((alive[nyears,])!=0)
mean(mean.r.a8[not.extinct]) 
sd(mean.r.a8[not.extinct])

# Population growth rate

mean(lambda.a8)
sd(lambda.a8)

# store lambda

write.csv(lambda.a8, "lambdaA8_car.csv")

# store persistence 

write.csv(persist.a8, "persistA8_car.csv")

```

### Extinction probabilities

```{r}

sum(N[3,nyears,]==0) / nsim

# calculation of quasi-extinction 

sum(apply(N[3,,1:nsim],2,min)<3)/nsim # adults only
pexta8u<-sum(apply(N[3,,1:nsim],2,min)<3)/nsim

sum(apply(colSums(N[-1,,1:nsim]),2,min)<3)/nsim # immatures and adults only


# Probability that population is equal to or smaller than the initial adult population size in year 1, 
# and probability that population is surviving, but equal to or less than the 2017 size.

sum(N[3,nyears,]<=N[3,1,1]) / nsim

sum((N[3,nyears,]<=14) & ( N[3,nyears,]>2)) / nsim


# Probability that the population is persisting and is larger than the initial adult population in year 1

sum((N[3,nyears,] > N[3,1,1])) / nsim

```

```{r}

# summary of population sizes at end of simulations

summary(N[3,51,])
alt8colonise.summary<-summary(N[3,51,])

```


```{r}


N.mean <- apply(N,c(1,2),mean)
N.sd <- apply(N, c(1,2), sd)
N.lci <- apply(N,c(1,2),quantile, probs=c(.025))
N.uci <- apply(N,c(1,2),quantile, probs=c(.975))
N.upr <- N.mean + 1.96*N.sd                       # upper 95% confidence level (1.96 * SD)
N.lwr <- N.mean - 1.96*N.sd                       # lower 95% confidence level
N.25 <- apply(N,c(1,2),quantile, probs=c(.25))    # lower quartile
N.50 <- apply(N,c(1,2),quantile, probs=c(.5))     # median quartile
N.75 <- apply(N,c(1,2),quantile, probs=c(.75))    # upper quartile


plot_results_a8update = data.frame(alt = "eightupdate", years = 1:51, N.mean=N.mean[3,], N.uci = N.uci[3,], N.lci=N.lci[3,], N.upr = N.upr[3,], N.lwr = N.lwr[3,], N.25 = N.25[3,],N.50 = N.50[3,], N.75 = N.75[3,])

# plot population projection with mean adult population size and uncertainty over 50 years
gg.a8<-ggplot(plot_results_a8update, aes(x=years, y=N.mean)) + 
  geom_ribbon(aes(x = years, ymax=N.upr, ymin=N.lwr),fill = "dimgrey", alpha=0.35) + geom_line(color="mediumblue", size=1.5, alpha=0.6) + theme_classic(base_size = 16)+  coord_cartesian(ylim=c(0,75))  + labs(title = "Predicted mean tara iti population size", x = "Year", y = "Population size (adult females)")

gg.a8

#plot(persist.a5, type = "l", lwd = 2, col="green") + lines(persist.a8, type = "l", lwd = 2, col = "purple")

#plot(density(lambda.a5), col="green") + lines(density(lambda.a8), col = "purple") + lines (density(lambda.SQf1))

write.csv(plot_results_a8update, "projA8_car.csv")

N50_a8<-N[3,51,1:nsim] # store the adult population sizes at the end of simulation

N25_a8<-N[3,25,1:nsim] # store the adult population sizes halfway through simulation

#
write.csv(N50_a8, "N50A8_car.csv")

```


# MODEL FIELD 2 NEW SITES WITH INFERTILE MALES REMOVED 29/10/2020

# Code for Alternative "Field 2 + new sites" WITH probability that birds find and breed at new sites

This simulation is field two management plus new sites as defined in alternative 5 (two sites, comprising the size of Ruakaka and GBI)

## Carrying capacity is set at two levels - as above

## Model assumptions - as above

## Infertile males are removed - fertility rate goes up to 0.9


Simulation:

```{r}

# Define the number of years with predictions and the Monte Carlo setting

nyears <- 50 # Number of years (projection time frame)
nsim <- 10000 # Number of replicate populations simulated


# Define empty arrays, vectors and initial stage-specific population sizes

Ni <- c(0, 3, 14) # starting population vector
N <- array(0, dim = c(3, nyears + 1, nsim)) # edited for three life stages
N[,1,] <- Ni 

alive <- matrix(0, nrow = nyears, ncol = nsim) 
r <- matrix(0, nrow = nyears, ncol = nsim)
mean.r.a8 <- numeric()
sj.val.a8 <- si.val.a8 <- sa.val.a8 <- Fa.val.a8 <- persist.a8<- lambda.a8<- numeric() 



## s is parametric uncertainty

# Define constants or non-elicited, fixed values

X <- 0.47                        #'cost' of management-reduction in prob of fledging from egg, calc from GLMM outputs
infer <-0.9                      # mean proportion of fertile eggs after infertile males removed
infer.e <- 0.08                  # uncertainty expressed as SD of the mean


# Define temporal variation 

Sjuv.t <- 0.01                 # temporal variability of juvenile survival (would be expressed as SD on logit scale)
Simm.t <- 0.01                 # temporal variability of immature survival (would be expressed as SD on logit scale)
Sad.t <- 0.01                  # temporal variability of immature survival (would be expressed as SD on logit scale)
h.t <- 0.2046                  # temporal variability of hatch prob (from model m2) expressed as untransformed SD
fl.t <- 0.2389                 # temporal variability of fledge prob (from model f3) expressed as untransformed SD

# Define carrying capacity, if using a fixed value

Car.lwr<- 18                  # most likely value for Field 2
Car.upr<- 24                  # most likely, elicited expert value for Field 2 + Captive 3
Car.I.upr <-2                 # elicited spaces in Ruakaka
Car.O.upr <-4                 # elicited spaces in GBI

# If looking at carrying capacity uncertainty, a scenario might be to double the K in all sites:

# Car.lwr<- 36                  # most likely value for Field 2
# Car.upr<- 48                  # most likely, elicited expert value for Field 2 + Captive 3
# Car.I.upr <-4                 # elicited spaces in Ruakaka
# Car.O.upr <-8                # elicited spaces in GBI

# high capacity - assume that we are wrong about FT ability to breed in colony

# Car.lwr<- 50                  # mock value for Field 2
# Car.upr<- 50                  # mock value for Field 2 + Captive 3
# Car.I.upr <-20                # mock spaces in Ruakaka
# Car.O.upr <-20                # mock spaces in GBI

Car<- matrix(NA,nrow=nyears+1,ncol=nsim) # Track carrying capacity across time and sim
Car[1,] <- Car.lwr # Carrying capacity in the first year is always the lowest value

Car.I <-matrix(NA,nrow=nyears+1,ncol=nsim)
Car.I[1,] <-Car.I.upr # Carrying capacity in the first year is at the upper bound as the site has just been created

Car.O <-matrix(NA,nrow=nyears+1,ncol=nsim)
Car.O[1,] <-Car.O.upr  # Carrying capacity in the first year is at the upper bound as the site has just been created

```

How many birds are there?

```{r}


# Project population

for (s in 1:nsim){                                          # Loop over replicate populations
  if(s %% 100 == 0) {cat(paste("*** Simrep", s, "***\n")) } # Counter
  
  p_out<-lapply(biol$parameter,rperty)
  p_out<- do.call(rbind, p_out)
  
  # Generate mean demographic values from elicited data
  
  # elicited survival parameters
  
  sj.sim <- as.numeric(filter(p_out, param == "sjuv.f2") %>% select(rpert_out)) # dplyr
  si.sim <- as.numeric(filter(p_out, param == "simm.f2") %>% select(rpert_out))
  sa.sim <- as.numeric(filter(p_out, param == "sad.f2") %>% select(rpert_out))
  
  # elicited breeding parameters
  
  h.sim <- as.numeric(filter(p_out, param == "h.f2") %>% select(rpert_out))
  fl.sim <- as.numeric(filter(p_out, param == "fl.f2") %>% select(rpert_out))
  M.sim <- as.numeric(filter(p_out, param == "M.f1") %>% select(rpert_out)) # same as Field 1
  K.sim <- as.numeric(filter(p_out, param == "K.f2") %>% select(rpert_out))
  c.sim <- as.numeric(filter(p_out, param == "c.f2") %>% select(rpert_out))
  
  
  # Generate annual demographic rates (subject to temporal variability)
  
  sj <- plogis(rnorm(nyears, qlogis(sj.sim), Sjuv.t))
  si <- plogis(rnorm(nyears, qlogis(si.sim), Simm.t))
  sa <- plogis(rnorm(nyears, qlogis(sa.sim), Sad.t))
  ha <- plogis(rnorm(nyears, h.sim, h.t))
  fla <- plogis(rnorm(nyears, fl.sim, fl.t))
  Ma <- rnorm(nyears, M.sim, 0) # no temporal var in M
  Ka <- rnorm(nyears, K.sim, 0) # no temporal var in prop of fem breeding
  ca <- rnorm(nyears, c.sim, 0) # no temporal var in clutch size
  
  #### elicited probabilities of colonisation ################################

prob.unlock.I.recruits<- as.numeric(filter(p_out, param == "p.unlock.I.rs") %>% select(rpert_out)) # recruits will unlock territories in range (e.g. Ruakaka) 2a
prob.unlock.I.floaters<- as.numeric(filter(p_out, param == "p.unlock.I.fs") %>% select(rpert_out)) # adult dispersers without a territory will unlock territories in range (e.g. Ruakaka)
prob.unlock.O.recruits<- as.numeric(filter(p_out, param == "p.unlock.O.rs") %>% select(rpert_out)) # recruits will unlock territories outside range (e.g. GBI)
prob.unlock.O.floaters<- as.numeric(filter(p_out, param == "p.unlock.O.fs") %>% select(rpert_out)) # adult dispersers without a territory will unlock territories outside range (e.g. GBI)

  
 ### Project population (include demographic stochasticity)
  
  for (t in 1:nyears){ # Loop over years
      # Step 1: fecundity
    
     Fa <- (Ka[t]*ca[t]*infer*((Ma[t]*X)+(1-Ma[t]))*(ha[t]*fla[t]))/2  # fecundity equation 
     
      # Step 2: dispersal 

### are there adult birds that don't hold a territory (floaters)? how many? 

  wild.dispersers<-ifelse(N[3,t,s]>Car[t,s], N[3,t,s] - Car[t,s], 0)
  
  # Or, if adults can disperse to new territories regardless of whether the breeding site is at carrying capacity:
	
  # wild.dispersers<-N[3,t,s]


# How many wild-born immatures from last year have survived to the adult stage?

  wild.recruits <- rbinom(1,N[2,t,s],si[t]) 

     # Step 3: determine carrying capacity for this year
  #  only wild recruits and wild dispersers in the population
  
  # wild recruits unlock first, INside range, then wild dispersers without territory, INside
  wr.unlock.I <- min(rbinom(1, wild.recruits, prob.unlock.I.recruits), Car.I[t,s])
  wd.unlock.I <-min(rbinom(1, wild.dispersers, prob.unlock.I.floaters), 
                    Car.I[t,s] - wr.unlock.I)
  
  # then wild recruits unlock OUTside range, then wild dispersers without territory, OUTside
  wr.unlock.O <-min(rbinom(1, wild.recruits - wr.unlock.I, prob.unlock.O.recruits), Car.O[t,s]) 
  wd.unlock.O <-min(rbinom(1, wild.dispersers - wd.unlock.I, prob.unlock.O.floaters), 
                    Car.O[t,s] - wr.unlock.O)
  
  new.unlock.I <- wr.unlock.I + wd.unlock.I # total unlocks inside range
  new.unlock.O <- wr.unlock.O + wd.unlock.O # total unlocks outside range
  
  # Car.I and Car.O have only slots that are left from the year previous (cap total carrying capacity here)
  Car.I[t+1,s] <- min(Car.I[t,s] - new.unlock.I, Car.I.upr)
  Car.O[t+1,s] <- min(Car.O[t,s] - new.unlock.O, Car.O.upr)
  
  # Car is last year's carrying capacity plus new unlocks (capped above)
  Car[t+1,s] <- Car[t,s] + new.unlock.I + new.unlock.O
  
  # Step 4: matrix for next year
  
    N[1,t+1,s] <- rpois(1, (min(Car[t,s], N[3,t,s]) * sa[t] * Fa))
    N[2,t+1,s] <- rbinom(1, (N[1,t,s]), sj[t])
    N[3,t+1,s] <- wild.recruits + rbinom(1, (N[3,t,s]), sa[t])
    
    r[t,s] <- ifelse(sum(N[,t+1,s]) == 0, 0, log(sum(N[,t+1,s])) - log(sum(N[,t,s]))) # calculate r for each time step in each sim
      alive[t,s] <- t
    
    persist.a8[t]<- sum(N[3,t,]>2)  / s # persistence probability at each timestep
    
  } # t
  
  sj.val.a8[s] = sj.sim
  si.val.a8[s] = si.sim
  sa.val.a8[s] = sa.sim
  Fa.val.a8[s] = Fa
  mean.r.a8[s] <- mean(r[min(alive[,s], na.rm = TRUE):max(alive[,s], na.rm = TRUE),s])
  lambda.a8[s] <- exp(mean.r.a8[s])
  
} # s

```


```{r}
# Intrinsic growth rates and population extinction probability

#Calculate the mean intrinsic growth rate (plus standard deviation) of all populations, and only populations that don't go extinct. 

#Calculate the probability of extinction after 50 years. Important to define what we class as 'extinction' here. The population has historically gone down to 3 known pairs. Makes sense to look at the rate of populations going to zero adults females and the rate of populations going down to 2 adult females.

#Mean intrinsic growth rate (and standard deviation)

mean(mean.r.a8) 
sd(mean.r.a8)

#Mean intrinsic growth rate of surviving populations

not.extinct <- which((alive[nyears,])!=0)
mean(mean.r.a8[not.extinct]) 
sd(mean.r.a8[not.extinct])

# Population growth rate

mean(lambda.a8)
sd(lambda.a8)

#store lambda

write.csv(lambda.a8, "lambda_A8_colonise_inf_07_12.csv")

#store persistence

write.csv(persist.a8, "persist_A8_colonise_inf_07_12.csv")

```

### Extinction probabilities

```{r}

sum(N[3,nyears,]==0) / nsim

# calculation of quasi-extinction 

sum(apply(N[3,,1:nsim],2,min)<3)/nsim # adults only
pexta8u<-sum(apply(N[3,,1:nsim],2,min)<3)/nsim

sum(apply(colSums(N[-1,,1:nsim]),2,min)<3)/nsim # immatures and adults only


# Probability that population is equal to or smaller than the initial adult population size in year 1, 
# and probability that population is surviving, but equal to or less than the 2017 size.

sum(N[3,nyears,]<=N[3,1,1]) / nsim

sum((N[3,nyears,]<=14) & ( N[3,nyears,]>2)) / nsim


# Probability that the population is persisting and is larger than the initial adult population in year 1

sum((N[3,nyears,] > N[3,1,1])) / nsim

```

```{r}

# summary of population sizes at end of simulations

summary(N[3,51,])
alt8colonise.summary<-summary(N[3,51,])

```


```{r}


N.mean <- apply(N,c(1,2),mean)
N.sd <- apply(N, c(1,2), sd)
N.lci <- apply(N,c(1,2),quantile, probs=c(.025))
N.uci <- apply(N,c(1,2),quantile, probs=c(.975))
N.upr <- N.mean + 1.96*N.sd                       # upper 95% confidence level (1.96 * SD)
N.lwr <- N.mean - 1.96*N.sd                       # lower 95% confidence level
N.25 <- apply(N,c(1,2),quantile, probs=c(.25))    # lower quartile
N.50 <- apply(N,c(1,2),quantile, probs=c(.5))     # median quartile
N.75 <- apply(N,c(1,2),quantile, probs=c(.75))    # upper quartile


plot_results_a8update = data.frame(alt = "eightupdate", years = 1:51, N.mean=N.mean[3,], N.uci = N.uci[3,], N.lci=N.lci[3,], N.upr = N.upr[3,], N.lwr = N.lwr[3,], N.25 = N.25[3,],N.50 = N.50[3,], N.75 = N.75[3,])

# plot population projection with mean adult population size and uncertainty over 50 years
gg.a8<-ggplot(plot_results_a8update, aes(x=years, y=N.mean)) + 
  geom_ribbon(aes(x = years, ymax=N.upr, ymin=N.lwr),fill = "dimgrey", alpha=0.35) + geom_line(color="mediumblue", size=1.5, alpha=0.6) + theme_classic(base_size = 16)+  coord_cartesian(ylim=c(0,75))  + labs(title = "Predicted mean tara iti population size", x = "Year", y = "Population size (adult females)")

gg.a8

#plot(persist.a5, type = "l", lwd = 2, col="green") + lines(persist.a8, type = "l", lwd = 2, col = "purple")

#plot(density(lambda.a5), col="green") + lines(density(lambda.a8), col = "purple") + lines (density(lambda.SQf1))

write.csv(plot_results_a8update, "proj_A8_colonise_inf_07_12.csv")

N50_a8<-N[3,51,1:nsim] # store the adult population sizes at the end of simulation

N25_a8<-N[3,25,1:nsim] # store the adult population sizes halfway through simulation

write.csv(N50_a8, "FinalpopsizeA8_colonise_inf_07_12.csv")
#write.csv(N[3,,1:nsim], "Pop_simulation_adults_A8-colonise.csv")

# N50_a8<-read.csv("C:\\Users\\thmcm\\Documents\\PhD - seabird conservation management\\Fairy Terns and SDM\\Decision Making\\TARA ITI WORKSHOP\\Phase 4\\Population modelling results\\Final pop sizes 5000 sims elicited K\\Final_pop_sizes_t=50_alt8_colonise.csv", header=T)
#N50_a8[,3]<-"A8 - F2 + newsites + colonise"

```


